# NSQ Client

ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„ NSQ å®¢æˆ·ç«¯åº“ï¼Œæ”¯æŒç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ä»¥åŠå¤±è´¥æ¶ˆæ¯å¤„ç†æœºåˆ¶ã€‚

## åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½
- **ç”Ÿäº§è€… (Producer)**ï¼šæ”¯æŒåŒæ­¥/å¼‚æ­¥æ¶ˆæ¯å‘é€
- **æ¶ˆè´¹è€… (Consumer)**ï¼šæ”¯æŒæ¶ˆæ¯æ¶ˆè´¹å’Œå¤„ç†
- **åŠ¨æ€ä¸»é¢˜/é¢‘é“åˆ›å»º**ï¼šè‡ªåŠ¨åˆ›å»ºä¸å­˜åœ¨çš„ä¸»é¢˜å’Œé¢‘é“
- **è¿æ¥ç®¡ç†**ï¼šæ”¯æŒå¤šä¸ª NSQD èŠ‚ç‚¹å’ŒæœåŠ¡å‘ç°
- **é…ç½®ç®¡ç†**ï¼šçµæ´»çš„ YAML é…ç½®æ–‡ä»¶æ”¯æŒ

### é«˜çº§åŠŸèƒ½
- **å¤±è´¥æ¶ˆæ¯å¤„ç†**ï¼šè‡ªåŠ¨æ•è·å¤±è´¥æ¶ˆæ¯å¹¶å‘é€åˆ°å¤±è´¥é˜Ÿåˆ— â­ **æ–°åŠŸèƒ½**
- **é‡è¯•æœºåˆ¶**ï¼šå¯é…ç½®çš„æ¶ˆæ¯é‡è¯•ç­–ç•¥
- **ç›‘æ§ç»Ÿè®¡**ï¼šè¯¦ç»†çš„è¿è¡Œæ—¶ç»Ÿè®¡ä¿¡æ¯
- **æ—¥å¿—è®°å½•**ï¼šå®Œæ•´çš„æ“ä½œæ—¥å¿—å’Œé”™è¯¯è·Ÿè¸ª
- **ä¼˜é›…å…³é—­**ï¼šæ”¯æŒä¼˜é›…çš„æœåŠ¡å…³é—­

## å¤±è´¥æ¶ˆæ¯å¤„ç†æœºåˆ¶ â­

å½“æ¶ˆæ¯æ¶ˆè´¹å¤±è´¥æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š

1. **æ•è·å¤±è´¥æ¶ˆæ¯**ï¼šè®°å½•å¤±è´¥åŸå› ã€æ—¶é—´æˆ³ã€é‡è¯•æ¬¡æ•°ç­‰ä¿¡æ¯
2. **å‘é€åˆ°å¤±è´¥é˜Ÿåˆ—**ï¼šå°†å¤±è´¥æ¶ˆæ¯å‘é€åˆ°ä¸“é—¨çš„å¤±è´¥é˜Ÿåˆ—
3. **æä¾›æŸ¥çœ‹å·¥å…·**ï¼šå¯ä»¥æŸ¥çœ‹å’Œåˆ†æå¤±è´¥æ¶ˆæ¯
4. **æ”¯æŒé‡æ–°å¤„ç†**ï¼šå¯ä»¥ä»å¤±è´¥é˜Ÿåˆ—é‡æ–°å¤„ç†æ¶ˆæ¯

### å¤±è´¥æ¶ˆæ¯ç»“æ„
```json
{
  "original_topic": "user_events",
  "original_channel": "user_processor", 
  "original_body": "åŸå§‹æ¶ˆæ¯å†…å®¹",
  "message_id": "æ¶ˆæ¯ID",
  "failure_reason": "å…·ä½“å¤±è´¥åŸå› ",
  "failure_time": "2024-01-01T12:00:00Z",
  "attempt_count": 5,
  "stack_trace": "é”™è¯¯å †æ ˆï¼ˆå¯é€‰ï¼‰",
  "processor_info": "å¤„ç†å™¨ä¿¡æ¯",
  "hostname": "ä¸»æœºå",
  "timestamp": 1704110400
}
```

## å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
go mod tidy
```

### 2. é…ç½®æ–‡ä»¶

å¤åˆ¶å¹¶ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š

```bash
cp config.yaml config/my_config.yaml
```

åœ¨é…ç½®æ–‡ä»¶ä¸­å¯ç”¨å¤±è´¥æ¶ˆæ¯å¤„ç†ï¼š

```yaml
consumer:
  # ... å…¶ä»–é…ç½® ...
  failed_message:
    enabled: true
    topic_suffix: "_failed_channel"
    max_retry_attempts: 3
    retry_delay: 1000
    include_stack_trace: true
```

### 3. è¿è¡Œç¤ºä¾‹

#### å¯åŠ¨å¸¦å¤±è´¥æ¶ˆæ¯å¤„ç†çš„æ¶ˆè´¹è€…
```bash
go run examples/failed_message_handling/consumer/main.go config.yaml my_topic my_channel
```

#### å¯åŠ¨å¤±è´¥æ¶ˆæ¯æŸ¥çœ‹å™¨
```bash
go run examples/failed_message_handling/viewer/main.go config.yaml my_topic
```

#### å‘é€æµ‹è¯•æ¶ˆæ¯
```bash
go run examples/producer_example.go config.yaml my_topic
```

### 4. è‡ªåŠ¨åŒ–æµ‹è¯•

è¿è¡Œå®Œæ•´çš„å¤±è´¥æ¶ˆæ¯å¤„ç†æµ‹è¯•ï¼š

```bash
./scripts/test_failed_message_handling.sh
```

## ä½¿ç”¨ç¤ºä¾‹

### åˆ›å»ºå¸¦å¤±è´¥æ¶ˆæ¯å¤„ç†çš„æ¶ˆè´¹è€…

```go
package main

import (
    "nsq-client/client/consumer"
    "nsq-client/client/producer"
    "nsq-client/config"
)

func main() {
    // åŠ è½½é…ç½®
    cfg, err := config.LoadConfig("config.yaml")
    if err != nil {
        panic(err)
    }

    // åˆ›å»ºç”Ÿäº§è€…ç”¨äºå‘é€å¤±è´¥æ¶ˆæ¯
    prod, err := producer.NewProducer(cfg)
    if err != nil {
        panic(err)
    }
    defer prod.Stop()

    // åˆ›å»ºå¸¦å¤±è´¥æ¶ˆæ¯å¤„ç†å™¨çš„æ¶ˆè´¹è€…
    cons, err := consumer.NewConsumerWithFailedMessageHandler(
        cfg, 
        "my_topic", 
        "my_channel", 
        messageHandler, 
        prod, // ä¼ å…¥ç”Ÿäº§è€…ç”¨äºå‘é€å¤±è´¥æ¶ˆæ¯
    )
    if err != nil {
        panic(err)
    }
    defer cons.Stop()

    // å¯åŠ¨æ¶ˆè´¹è€…
    if err := cons.Start(); err != nil {
        panic(err)
    }

    // ... ç­‰å¾…é€€å‡ºä¿¡å· ...
}

func messageHandler(message *nsq.Message) error {
    // ä½ çš„æ¶ˆæ¯å¤„ç†é€»è¾‘
    // å¦‚æœè¿”å›é”™è¯¯ï¼Œæ¶ˆæ¯ä¼šåœ¨é‡è¯•æ¬¡æ•°ç”¨å®Œåè¢«å‘é€åˆ°å¤±è´¥é˜Ÿåˆ—
    return processMessage(message)
}
```

## é¡¹ç›®ç»“æ„

```
nsq-client/
â”œâ”€â”€ client/
â”‚   â”œâ”€â”€ consumer/           # æ¶ˆè´¹è€…å®ç°
â”‚   â”‚   â”œâ”€â”€ consumer.go
â”‚   â”‚   â””â”€â”€ failed_message_handler.go  # å¤±è´¥æ¶ˆæ¯å¤„ç†å™¨ â­
â”‚   â””â”€â”€ producer/           # ç”Ÿäº§è€…å®ç°
â”‚       â””â”€â”€ producer.go
â”œâ”€â”€ config/                 # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ config.go
â”‚   â””â”€â”€ config.yaml
â”œâ”€â”€ examples/               # ç¤ºä¾‹ç¨‹åº
â”‚   â”œâ”€â”€ consumer_example.go
â”‚   â”œâ”€â”€ failed_message_handling/                 # å¤±è´¥æ¶ˆæ¯å¤„ç†ç¤ºä¾‹ â­
â”‚   â”‚   â”œâ”€â”€ consumer/main.go                     # å¸¦å¤±è´¥å¤„ç†çš„æ¶ˆè´¹è€…
â”‚   â”‚   â””â”€â”€ viewer/main.go                       # å¤±è´¥æ¶ˆæ¯æŸ¥çœ‹å™¨
â”‚   â””â”€â”€ producer_example.go
â”œâ”€â”€ docs/                   # æ–‡æ¡£
â”‚   â””â”€â”€ failed_message_handling.md               # å¤±è´¥æ¶ˆæ¯å¤„ç†æ–‡æ¡£ â­
â””â”€â”€ scripts/                # è„šæœ¬
    â””â”€â”€ test_failed_message_handling.sh          # æµ‹è¯•è„šæœ¬ â­
```

## é…ç½®è¯´æ˜

### åŸºç¡€é…ç½®

```yaml
# NSQ æœåŠ¡å™¨é…ç½®
nsq:
  nsqd_addresses:
    - "172.16.1.40:4150"
  nsqlookupd_addresses:
    - "172.16.1.40:4161"

# ç”Ÿäº§è€…é…ç½®
producer:
  default_topic: "test_topic"
  publish_timeout: 5000
  max_in_flight: 200

# æ¶ˆè´¹è€…é…ç½®
consumer:
  default_topic: "test_topic"
  default_channel: "test_channel"
  max_in_flight: 200
  msg_timeout: 60
  max_attempts: 5
  requeue_delay: 90000
```

### å¤±è´¥æ¶ˆæ¯å¤„ç†é…ç½® â­

```yaml
consumer:
  failed_message:
    enabled: true                    # å¯ç”¨å¤±è´¥æ¶ˆæ¯å¤„ç†
    topic_suffix: "_failed_channel"  # å¤±è´¥é˜Ÿåˆ—åç¼€
    max_retry_attempts: 3            # å‘é€å¤±è´¥æ¶ˆæ¯çš„é‡è¯•æ¬¡æ•°
    retry_delay: 1000               # é‡è¯•å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
    include_stack_trace: true       # åŒ…å«é”™è¯¯å †æ ˆ
```

## ç›‘æ§å’Œè¿ç»´

### ç»Ÿè®¡ä¿¡æ¯

æ¶ˆè´¹è€…æä¾›è¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¤±è´¥æ¶ˆæ¯å¤„ç†ç»Ÿè®¡ï¼š

```go
stats := consumer.GetStats()
// è¾“å‡ºåŒ…å«ï¼š
// - connection_count: è¿æ¥æ•°
// - message_count: æ¶ˆæ¯æ€»æ•°
// - message_finished: å®Œæˆæ¶ˆæ¯æ•°
// - message_requeued: é‡æ–°æ’é˜Ÿæ¶ˆæ¯æ•°
// - failed_message_handler: å¤±è´¥æ¶ˆæ¯å¤„ç†ç»Ÿè®¡ â­
```

### æ—¥å¿—è®°å½•

ç³»ç»Ÿæä¾›å®Œæ•´çš„æ—¥å¿—è®°å½•ï¼š
- æ¶ˆæ¯å¤„ç†æ—¥å¿—
- å¤±è´¥æ¶ˆæ¯å¤„ç†æ—¥å¿— â­
- è¿æ¥çŠ¶æ€æ—¥å¿—
- é”™è¯¯å’Œå¼‚å¸¸æ—¥å¿—

### å¤±è´¥é˜Ÿåˆ—ç›‘æ§ â­

å»ºè®®å¯¹å¤±è´¥é˜Ÿåˆ—è¿›è¡Œç›‘æ§ï¼š
- å¤±è´¥æ¶ˆæ¯æ•°é‡å‘Šè­¦
- å¤±è´¥åŸå› åˆ†æ
- å¤„ç†æ—¶é—´ç›‘æ§
- é‡è¯•æˆåŠŸç‡ç»Ÿè®¡

## æœ€ä½³å®è·µ

1. **å¤±è´¥æ¶ˆæ¯å¤„ç†**ï¼š
   - å¯ç”¨å¤±è´¥æ¶ˆæ¯å¤„ç†åŠŸèƒ½
   - å®šæœŸæ£€æŸ¥å¤±è´¥é˜Ÿåˆ—
   - åˆ†æå¤±è´¥åŸå› å¹¶ä¼˜åŒ–ä»£ç 

2. **é…ç½®ä¼˜åŒ–**ï¼š
   - æ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´é‡è¯•æ¬¡æ•°
   - åˆç†è®¾ç½®æ¶ˆæ¯è¶…æ—¶æ—¶é—´
   - é…ç½®é€‚å½“çš„å¹¶å‘æ•°

3. **ç›‘æ§å‘Šè­¦**ï¼š
   - ç›‘æ§å¤±è´¥é˜Ÿåˆ—æ¶ˆæ¯æ•°é‡
   - è®¾ç½®è¿æ¥çŠ¶æ€å‘Šè­¦
   - è·Ÿè¸ªæ¶ˆæ¯å¤„ç†æ€§èƒ½

4. **é”™è¯¯å¤„ç†**ï¼š
   - å®ç°å¹‚ç­‰æ€§æ¶ˆæ¯å¤„ç†
   - åŒºåˆ†ä¸´æ—¶æ€§å’Œæ°¸ä¹…æ€§é”™è¯¯
   - æä¾›äººå·¥å¹²é¢„æœºåˆ¶

## æ–‡æ¡£

- [å¤±è´¥æ¶ˆæ¯å¤„ç†è¯¦ç»†æ–‡æ¡£](docs/failed_message_handling.md) â­
- [é…ç½®æ–‡ä»¶è¯´æ˜](config.yaml)
- [ç¤ºä¾‹ç¨‹åºè¯´æ˜](examples/)

## ä¾èµ–

- Go 1.19+
- github.com/nsqio/go-nsq
- gopkg.in/yaml.v3
- mlog (æ—¥å¿—åº“)

## è®¸å¯è¯

MIT License

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## æ›´æ–°æ—¥å¿—

### v1.1.0 â­ æ–°ç‰ˆæœ¬
- âœ¨ æ–°å¢å¤±è´¥æ¶ˆæ¯å¤„ç†æœºåˆ¶
- âœ¨ æ–°å¢å¤±è´¥æ¶ˆæ¯æŸ¥çœ‹å™¨
- âœ¨ æ–°å¢å¤±è´¥æ¶ˆæ¯å¤„ç†é…ç½®
- âœ¨ æ–°å¢è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
- ğŸ“š å®Œå–„æ–‡æ¡£å’Œç¤ºä¾‹

### v1.0.0
- ğŸ‰ åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- âœ¨ æ”¯æŒç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…
- âœ¨ æ”¯æŒåŠ¨æ€ä¸»é¢˜/é¢‘é“åˆ›å»º
- âœ¨ æ”¯æŒé…ç½®ç®¡ç†å’Œæ—¥å¿—è®°å½•
